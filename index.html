import React from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth } from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    doc, 
    addDoc, 
    setDoc, 
    getDoc, 
    onSnapshot, 
    deleteDoc, 
    updateDoc,
    query,
    where,
    getDocs
} from 'firebase/firestore';
import { 
    LayoutDashboard, 
    Users, 
    Briefcase, 
    BrainCircuit, 
    Settings, 
    LogOut, 
    Menu, 
    X,
    Landmark,
    Plus,
    Trash2,
    Edit3,
    UserPlus
} from 'lucide-react';

// --- INÍCIO: Configuração do Firebase ---
// A configuração continua aqui para que o painel possa ligar-se à base de dados.
const firebaseConfig = {
    apiKey: "AIzaSyBvl8gmVO911uUb3NKG2Mob7ts50QPPwqI",
    authDomain: "advogado-4ae58.firebaseapp.com",
    projectId: "advogado-4ae58",
    storageBucket: "advogado-4ae58.appspot.com",
    messagingSenderId: "139606815200",
    appId: "1:139606815200:web:ce7920ac5ac984c9b7fb85",
    measurementId: "G-ZVK575RTRP"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
// --- FIM: Configuração do Firebase ---

// --- Componentes da UI (Interface do Utilizador) ---

const Tooltip = ({ message, children }) => (
  <div className="relative flex flex-col items-center group">
    {children}
    <div className="absolute bottom-0 flex-col items-center hidden mb-6 group-hover:flex">
      <span className="relative z-10 p-2 text-xs leading-none text-white whitespace-no-wrap bg-gray-800 shadow-lg rounded-md">{message}</span>
      <div className="w-3 h-3 -mt-2 rotate-45 bg-gray-800"></div>
    </div>
  </div>
);

const Modal = ({ isOpen, onClose, title, children }) => {
    if (!isOpen) return null;
    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                <div className="flex justify-between items-center p-4 border-b sticky top-0 bg-white">
                    <h3 className="text-xl font-semibold text-gray-800">{title}</h3>
                    <button onClick={onClose} className="text-gray-500 hover:text-gray-800 transition-colors">
                        <X size={24} />
                    </button>
                </div>
                <div className="p-6">
                    {children}
                </div>
            </div>
        </div>
    );
};

const Spinner = () => (
    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
);

// --- Componentes do Painel de Administração ---

const AdminDashboard = ({ user, userRole, onLogout }) => {
    const [activeView, setActiveView] = React.useState('dashboard');
    const [isSidebarOpen, setIsSidebarOpen] = React.useState(false);
    
    const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard },
        { id: 'clients', label: 'Clientes', icon: Users },
        { id: 'cases', label: 'Processos', icon: Briefcase },
        { id: 'ai_tool', label: 'Ferramenta IA', icon: BrainCircuit },
        ...(userRole === 'main_admin' ? [{ id: 'settings', label: 'Configurações', icon: Settings }] : [])
    ];

    const renderView = () => {
        switch (activeView) {
            case 'clients': return <ClientManagement userRole={userRole} />;
            case 'ai_tool': return <AITool />;
            case 'settings': return userRole === 'main_admin' ? <SettingsPanel /> : <p>Acesso negado.</p>;
            case 'cases':
            case 'dashboard':
            default:
                return <DashboardView setActiveView={setActiveView} />;
        }
    };
    
    const Sidebar = () => (
        <aside className={`bg-gray-800 text-white w-64 space-y-6 py-7 px-2 absolute inset-y-0 left-0 transform ${isSidebarOpen ? "translate-x-0" : "-translate-x-full"} md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30`}>
            <div className="flex items-center justify-between px-4">
                <div className="flex items-center space-x-2">
                    <Landmark className="w-8 h-8 text-blue-400" />
                    <span className="text-xl font-bold">Advocacia Pro</span>
                </div>
                <button className="md:hidden" onClick={() => setIsSidebarOpen(false)}><X/></button>
            </div>
            <nav>
                {navItems.map(item => (
                    <button key={item.id} onClick={() => { setActiveView(item.id); setIsSidebarOpen(false); }} className={`w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${activeView === item.id ? 'bg-blue-600' : 'hover:bg-gray-700'}`}>
                        <item.icon className="w-5 h-5" />
                        <span>{item.label}</span>
                    </button>
                ))}
            </nav>
            <div className="absolute bottom-0 w-full left-0 px-4 py-6">
                <button onClick={onLogout} className="w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors bg-gray-700 hover:bg-gray-600 cursor-not-allowed opacity-60">
                    <LogOut className="w-5 h-5" />
                    <span>Sair (Desativado)</span>
                </button>
            </div>
        </aside>
    );

    return (
        <div className="flex h-screen bg-gray-100">
            <Sidebar />
            <div className="flex-1 flex flex-col overflow-hidden">
                <header className="flex justify-between items-center p-4 bg-white border-b">
                    <button className="md:hidden" onClick={() => setIsSidebarOpen(true)}>
                        <Menu />
                    </button>
                    <h2 className="text-xl font-semibold text-gray-700 capitalize">{navItems.find(i => i.id === activeView)?.label}</h2>
                    <div className="flex items-center space-x-2">
                        <span className="text-sm text-gray-600 hidden sm:block">{user.email} ({userRole === 'main_admin' ? 'Admin Principal' : 'Admin Secundário'})</span>
                    </div>
                </header>
                <main className="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                    {renderView()}
                </main>
            </div>
        </div>
    );
};

// --- Sub-componentes do Dashboard ---

const DashboardView = ({ setActiveView }) => (
    <div>
        <h3 className="text-2xl font-semibold text-gray-800 mb-6">Bem-vindo ao seu Painel de Gestão</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div onClick={() => setActiveView('clients')} className="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer">
                <Users className="w-10 h-10 text-blue-500 mb-4" />
                <h4 className="text-xl font-semibold text-gray-700">Gerir Clientes</h4>
                <p className="text-gray-500 mt-2">Aceda, adicione e atualize informações dos seus clientes.</p>
            </div>
            <div onClick={() => setActiveView('cases')} className="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer">
                <Briefcase className="w-10 h-10 text-green-500 mb-4" />
                <h4 className="text-xl font-semibold text-gray-700">Gerir Processos</h4>
                <p className="text-gray-500 mt-2">Acompanhe o andamento de todos os seus casos (em breve).</p>
            </div>
            <div onClick={() => setActiveView('ai_tool')} className="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer">
                <BrainCircuit className="w-10 h-10 text-purple-500 mb-4" />
                <h4 className="text-xl font-semibold text-gray-700">Análise com IA</h4>
                <p className="text-gray-500 mt-2">Utilize inteligência artificial para otimizar as suas petições e análises.</p>
            </div>
        </div>
    </div>
);

const ClientManagement = ({ userRole }) => {
    const [clients, setClients] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(true);
    const [isModalOpen, setIsModalOpen] = React.useState(false);
    const [editingClient, setEditingClient] = React.useState(null);

    React.useEffect(() => {
        const clientsCollectionRef = collection(db, 'clients');
        const q = query(clientsCollectionRef);
        const unsubscribe = onSnapshot(q, (querySnapshot) => {
            const clientsData = [];
            querySnapshot.forEach((doc) => {
                clientsData.push({ id: doc.id, ...doc.data() });
            });
            clientsData.sort((a, b) => a.name.localeCompare(b.name));
            setClients(clientsData);
            setIsLoading(false);
        }, (error) => {
            console.error("Erro ao buscar clientes: ", error);
            setIsLoading(false);
        });

        return () => unsubscribe();
    }, []);

    const handleAddClient = () => {
        setEditingClient(null);
        setIsModalOpen(true);
    };

    const handleEditClient = (client) => {
        setEditingClient(client);
        setIsModalOpen(true);
    };

    const handleDeleteClient = async (clientId) => {
        if (userRole !== 'main_admin') {
            alert("Não tem permissão para excluir clientes.");
            return;
        }
        if (confirm("Tem a certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.")) {
            try {
                await deleteDoc(doc(db, 'clients', clientId));
            } catch (error) {
                console.error("Erro ao excluir cliente: ", error);
            }
        }
    };

    const handleSaveClient = async (clientData) => {
        try {
            if (editingClient) {
                const clientRef = doc(db, 'clients', editingClient.id);
                await updateDoc(clientRef, clientData);
            } else {
                await addDoc(collection(db, 'clients'), clientData);

